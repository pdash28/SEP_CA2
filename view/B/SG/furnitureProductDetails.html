<!-- <script src="../checkCountry.js"></script>
<html>
    <script src="../../header.js"></script>
    <body>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
            // Use URL and URLSearchParams to create URLs
            var currentUrl = new URL(window.location.href);
            var sku = currentUrl.searchParams.get("sku");
            var memberEmail = sessionStorage.getItem('memberEmail');
            var countryId = localStorage.getItem('countryId');
            var countryPrefix = localStorage.getItem('urlPrefix');

            if (!sku) {
                window.location.href = new URL(`/B/${countryPrefix}/index.html`, window.location.origin);
            }

            fetch(new URL(`/api/getFurnitureBySku?sku=${sku}&countryId=${countryId}`, window.location.origin))
                .then(response => response.json())
                .then(furniture => {
                    // Use safer methods to add HTML content
                    document.getElementById("imgFurniture").src = furniture.imageURL;
                    document.getElementById("furnitureName").textContent = furniture.name;
                    document.getElementById("price").textContent = `$${furniture.price}`;
                    document.getElementById("description").textContent = furniture.description;
                    var categoryLink = document.getElementById("categoryLink");
                    categoryLink.textContent = furniture.category;
                    categoryLink.href = new URL(`/B/${countryPrefix}/furnitureCategory.html?cat=${encodeURIComponent(furniture.category)}`, window.location.origin);

                    if (memberEmail) {
                    var addToCartBtn = document.getElementById("addToCartBtn");
                    var button = document.createElement("button");
                    button.className = "btn btn-primary";
                    button.onclick = function() { addToCart(furniture.sku, furniture.id, furniture.price, furniture.name, furniture.imageURL); };
                    button.textContent = "Add To Cart";
                    addToCartBtn.appendChild(button);
                }

                // Initialize favorites
                let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
                const favoriteIcon = document.getElementById("favoriteIcon");
                const heartIcon = favoriteIcon.querySelector('i');

                if (favorites.includes(sku)) {
                heartIcon.style.color = 'red';
                }

                favoriteIcon.addEventListener("click", function() {
                    if (favorites.includes(sku)) {
                        favorites = favorites.filter(fav => fav !== sku);
                        heartIcon.style.color = 'grey';
                        alert("Removed from Favorites");
                    } else {
                        favorites.push(sku);
                        heartIcon.style.color = 'red';
                        alert("Added to Favorites");
                    }
                    localStorage.setItem("favorites", JSON.stringify(favorites));
                });

                function checkIfFavourite() {
                    var memberDataString = sessionStorage.getItem('member');
                    var memberData = JSON.parse(memberDataString);
                    var id = memberData.id;
                    var sku = currentUrl.searchParams.get("sku");
                    console.log("Checking Favs: " + id + " " + sku);
                    fetch(new Request('/api/checkIfFavourite?id=' + id + '&sku=' + sku, {
                        method: 'GET',
                    })).then (function (response) {
                        return response.json();
                    }).then(function (data) {
                        console.log ("Data: " + data);
                        if (data.favourite == true) {
                            console.log("Fav");
                            document.getElementById("favoriteBtn").innerHTML = '<i class="fa fa-heart"></i>';
                        } else {
                            console.log("Not Fav");
                            document.getElementById("favoriteBtn").innerHTML = '<i class="fa fa-heart-o"></i>';
                        }
                    }).catch(function(error) {
                        console.log(error);
                    });
                }

                // Populate store options
                let storeID = currentUrl.searchParams.get("storeID");
                let storesInCountry = JSON.parse(localStorage.getItem('storesInCountry'));
                let selectOptions = storesInCountry.map(store => 
                    `<option value="${store.id}" ${store.id === storeID ? 'selected' : ''}>${store.name}</option>`
                ).join('');
                document.getElementById("storeID").innerHTML = selectOptions;

                // Display quantity
                let itemQty = currentUrl.searchParams.get("itemQty");
                if (itemQty != null) {
                    document.getElementById("quantityDiv").innerHTML = `
                        <div class="col-md-6">
                            Status: ${itemQty > 0 ? 'Available' : 'Unavailable'}<br/>
                            Remaining Qty: ${itemQty}
                        </div>`;
                }
            })
            .catch(error => {
                // Handle errors properly
                console.error(error);
                alert("An error occurred while fetching furniture details. Please try again.");
            });
        });

            function addToCart(sku, id, price, name, imageURL) {
                fetch(new URL(`/api/getItemQuantity?sku=${sku}&storeId=-1`, window.location.origin))
                .then(response => response.json())
                .then(data => {
                    var quantity = data[0].sum;
                    if (!quantity) {
                        alert("Item not added to cart, not enough quantity available.");
                    return;
                    }

            var shoppingCart = JSON.parse(sessionStorage.getItem('shoppingCart')) || [];
            var cartItem = shoppingCart.find(item => item.sku === sku);

            if (cartItem) {
                if (cartItem.quantity >= quantity) {
                    alert("Item not added to cart, not enough quantity available.");
                    return;
                } else {
                    cartItem.quantity += 1;
                }
            } else {
                shoppingCart.push({
                    id: id,
                    sku: sku,
                    price: price,
                    name: name,
                    imgURL: imageURL,
                    quantity: 1
                });
            }

                sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                alert("Successfully added!");
            })
            .catch(error => {
                console.error(error);
                alert("An error occurred while adding item to cart. Please try again.");
            });
        }

            function CheckItemAvail() {
                var storeId = document.getElementById("storeID").value;
                if (storeId) {
                    fetch(new URL(`/api/getItemQuantity?sku=${sku}&storeId=${storeId}`, window.location.origin))
                    .then(response => response.json())
                    .then(data => {
                        var quantity = data[0].sum || 0;
                        window.location.href = new URL(`${window.location.origin}${window.location.pathname}?sku=${sku}&itemQty=${quantity}&storeID=${storeId}`);
                    })
                    .catch(error => {
                    console.error(error);
                    alert("An error occurred while checking item availability. Please try again.");
                });
            }
        }
        </script>
        <div class="body">
            <script src="menu2.js"></script>
            <div class="body">
                <div role="main" class="main">
                    <section class="page-top">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12">
                                    <h2>Furnitures</h2>
                                </div>
                            </div>
                        </div>
                    </section>
                    <div class="container">
                        <script src="/displayMessageLong.js"></script>
                        <div class="row">
                            <div class="col-md-6">
                                <div>
                                    <div class="thumbnail">
                                        <img alt="" class="img-responsive img-rounded" id="imgFurniture">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="summary entry-summary">
                                    <h2 class="shorter"><strong id="furnitureName"></strong></h2>
                                    <div id="buttonContainer">
                                        <button id="addToCartBtn" class="btn btn-primary"></button>
                                        <div id="favoriteIcon" class="btn btn-icon" style="margin-left: auto;">
                                            <i class="fa fa-heart not-favorited"></i>
                                        </div>
                                    </div>
                                    
                                    <p class="price"><h4 class="amount" id="price"></h4></p>
                                    <strong>Description</strong>
                                    <p class="taller" id="description"></p>
                                    <p id="furnitureInfo"></p>
                                    <div class="product_meta">
                                        <span class="posted_in">Category: <a id="categoryLink" rel="tag"></a></span>
                                    </div>
                                    <br/><br/>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <form onsubmit="return false;">
                                                View Item Availability<br/>
                                                <select style="color: black;" name="storeID" id="storeID"></select><br/><br/>
                                                <input type="submit" onclick="CheckItemAvail()" class="btn btn-primary btn-icon" value="Check Item Availability"/>
                                            </form>
                                        </div>
                                        <div id="quantityDiv"></div>
                                    </div>
                                </div>
                            </div>
                            <hr class="tall">
                        </div>
                    </div>
                </div>
            </div>
            <script src="../footer.js"></script>
        </div>
   </body>
</html>  -->


<script src="../checkCountry.js"></script>
<html>
    <script src="../../header.js"></script>
    <body>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                var currentUrl = new URL(window.location.href);
                var sku = currentUrl.searchParams.get("sku");
                var memberEmail = sessionStorage.getItem('memberEmail');
                var countryId = localStorage.getItem('countryId');
                var countryPrefix = localStorage.getItem('urlPrefix');

                if (!sku) {
                    window.location.href = new URL(`/B/${countryPrefix}/index.html`, window.location.origin);
                }

                fetch(new URL(`/api/getFurnitureBySku?sku=${sku}&countryId=${countryId}`, window.location.origin))
                    .then(response => response.json())
                    .then(furniture => {
                        document.getElementById("imgFurniture").src = furniture.imageURL;
                        document.getElementById("furnitureName").textContent = furniture.name;
                        document.getElementById("price").textContent = `$${furniture.price}`;
                        document.getElementById("description").textContent = furniture.description;
                        var categoryLink = document.getElementById("categoryLink");
                        categoryLink.textContent = furniture.category;
                        categoryLink.href = new URL(`/B/${countryPrefix}/furnitureCategory.html?cat=${encodeURIComponent(furniture.category)}`, window.location.origin);

                        if (memberEmail) {
                            var addToCartBtn = document.getElementById("addToCartBtn");
                            var button = document.createElement("button");
                            button.className = "btn btn-primary";
                            button.onclick = function() { addToCart(furniture.sku, furniture.id, furniture.price, furniture.name, furniture.imageURL); };
                            button.textContent = "Add To Cart";
                            addToCartBtn.appendChild(button);

                            var favoriteIcon = document.getElementById("favoriteIcon");
                            favoriteIcon.innerHTML = ''; // Clear any existing icons
                            var heartIcon = document.createElement("i");
                            heartIcon.className = "fa fa-heart not-favorited";
                            favoriteIcon.appendChild(heartIcon);

                            let favorites = JSON.parse(localStorage.getItem("favorites")) || [];

                            if (favorites.includes(sku)) {
                                heartIcon.style.color = 'red';
                            }

                            favoriteIcon.addEventListener("click", function() {
                                if (favorites.includes(sku)) {
                                    favorites = favorites.filter(fav => fav !== sku);
                                    heartIcon.style.color = 'grey';
                                    alert("Removed from Favorites");
                                } else {
                                    favorites.push(sku);
                                    heartIcon.style.color = 'red';
                                    alert("Added to Favorites");
                                }
                                localStorage.setItem("favorites", JSON.stringify(favorites));
                            });

                            checkIfFavourite();
                        } else {
                            document.getElementById("addToCartBtn").style.display = 'none';
                            document.getElementById("favoriteIcon").style.display = 'none';
                        }

                        let storeID = currentUrl.searchParams.get("storeID");
                        let storesInCountry = JSON.parse(localStorage.getItem('storesInCountry'));
                        let selectOptions = storesInCountry.map(store => 
                            `<option value="${store.id}" ${store.id === storeID ? 'selected' : ''}>${store.name}</option>`
                        ).join('');
                        document.getElementById("storeID").innerHTML = selectOptions;

                        let itemQty = currentUrl.searchParams.get("itemQty");
                        if (itemQty != null) {
                            document.getElementById("quantityDiv").innerHTML = `
                                <div class="col-md-6">
                                    Status: ${itemQty > 0 ? 'Available' : 'Unavailable'}<br/>
                                    Remaining Qty: ${itemQty}
                                </div>`;
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        alert("An error occurred while fetching furniture details. Please try again.");
                    });
            });

            function addToCart(sku, id, price, name, imageURL) {
                fetch(new URL(`/api/getItemQuantity?sku=${sku}&storeId=-1`, window.location.origin))
                .then(response => response.json())
                .then(data => {
                    var quantity = data[0].sum;
                    if (!quantity) {
                        alert("Item not added to cart, not enough quantity available.");
                        return;
                    }

                    var shoppingCart = JSON.parse(sessionStorage.getItem('shoppingCart')) || [];
                    var cartItem = shoppingCart.find(item => item.sku === sku);

                    if (cartItem) {
                        if (cartItem.quantity >= quantity) {
                            alert("Item not added to cart, not enough quantity available.");
                            return;
                        } else {
                            cartItem.quantity += 1;
                        }
                    } else {
                        shoppingCart.push({
                            id: id,
                            sku: sku,
                            price: price,
                            name: name,
                            imgURL: imageURL,
                            quantity: 1
                        });
                    }

                    sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                    alert("Successfully added!");
                })
                .catch(error => {
                    console.error(error);
                    alert("An error occurred while adding item to cart. Please try again.");
                });
            }

            function CheckItemAvail() {
                var storeId = document.getElementById("storeID").value;
                if (storeId) {
                    fetch(new URL(`/api/getItemQuantity?sku=${sku}&storeId=${storeId}`, window.location.origin))
                    .then(response => response.json())
                    .then(data => {
                        var quantity = data[0].sum || 0;
                        window.location.href = new URL(`${window.location.origin}${window.location.pathname}?sku=${sku}&itemQty=${quantity}&storeID=${storeId}`);
                    })
                    .catch(error => {
                        console.error(error);
                        alert("An error occurred while checking item availability. Please try again.");
                    });
                }
            }

            function checkIfFavourite() {
                var memberDataString = sessionStorage.getItem('member');
                var memberData = JSON.parse(memberDataString);
                var id = memberData.id;
                var sku = new URL(window.location.href).searchParams.get("sku");
                console.log("Checking Favs: " + id + " " + sku);
                fetch(new Request('/api/checkIfFavourite?id=' + id + '&sku=' + sku, {
                    method: 'GET',
                })).then (function (response) {
                    return response.json();
                }).then(function (data) {
                    console.log ("Data: " + data);
                    var favoriteIcon = document.getElementById("favoriteIcon");
                    if (data.favourite == true) {
                        console.log("Fav");
                        favoriteIcon.innerHTML = '<i class="fa fa-heart" style="color: red;"></i>';
                    } else {
                        console.log("Not Fav");
                        favoriteIcon.innerHTML = '<i class="fa fa-heart-o"></i>';
                    }
                }).catch(function(error) {
                    console.log(error);
                });
            }
        </script>
        <div class="body">
            <script src="menu2.js"></script>
            <div class="body">
                <div role="main" class="main">
                    <section class="page-top">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12">
                                    <h2>Furnitures</h2>
                                </div>
                            </div>
                        </div>
                    </section>
                    <div class="container">
                        <script src="/displayMessageLong.js"></script>
                        <div class="row">
                            <div class="col-md-6">
                                <div>
                                    <div class="thumbnail">
                                        <img alt="" class="img-responsive img-rounded" id="imgFurniture">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="summary entry-summary">
                                    <h2 class="shorter"><strong id="furnitureName"></strong></h2>
                                    <div id="buttonContainer">
                                        <div id="addToCartBtn" style="display: inline-block;"></div>
                                        <div id="favoriteIcon" class="btn btn-icon" style="display: inline-block;"></div>
                                    </div>
                                    
                                    <p class="price"><h4 class="amount" id="price"></h4></p>
                                    <strong>Description</strong>
                                    <p class="taller" id="description"></p>
                                    <p id="furnitureInfo"></p>
                                    <div class="product_meta">
                                        <span class="posted_in">Category: <a id="categoryLink" rel="tag"></a></span>
                                    </div>
                                    <br/><br/>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <form onsubmit="return false;">
                                                View Item Availability<br/>
                                                <select style="color: black;" name="storeID" id="storeID"></select><br/><br/>
                                                <input type="submit" onclick="CheckItemAvail()" class="btn btn-primary btn-icon" value="Check Item Availability"/>
                                            </form>
                                        </div>
                                        <div id="quantityDiv"></div>
                                    </div>
                                </div>
                            </div>
                            <hr class="tall">
                        </div>
                    </div>
                </div>
            </div>
            <script src="../footer.js"></script>
        </div>
   </body>
</html> 
